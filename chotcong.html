<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chốt Công — WAREHOUSE RYOBI</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ========== THEME (dark auto) ========== */
:root{
  --bg:#f5f7fa; --text:#111; --box:#fff; --muted:#666; --accent:#00bcd4; --border:#e6e6e6;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0f1113; --text:#e6eef6; --box:#141518; --muted:#9aa3ad; --accent:#2ec4d6; --border:#222427; }
}
*{box-sizing:border-box}
body{
  margin:18px; font-family:"Be Vietnam Pro",sans-serif; background:var(--bg); color:var(--text);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* header */
h1{ font-size:28px; margin:0 0 6px; font-weight:800; background:linear-gradient(90deg,#4facfe,#00f2fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
p.desc{ margin:4px 0 16px; color:var(--muted); font-size:13px; }

/* toolbar */
.toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
.input, .select, .num { padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--box); color:var(--text); }
.input{ min-width:220px; width:34%; font-size:14px; }
.select{ min-width:160px; }
.num{ width:120px; }

/* buttons */
.btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; color:#fff; background:linear-gradient(135deg,#16a085,#27ae60); }
.btn.secondary { background:linear-gradient(135deg,#4facfe,#00f2fe); color:#022; }

/* table */
.table-wrap{ overflow:auto; border-radius:12px; background:var(--box); box-shadow:0 8px 30px rgba(0,0,0,0.04); border:1px solid var(--border); }
table{ width:100%; border-collapse:collapse; min-width:980px; }
thead th{ position:sticky; top:0; background:rgba(0,0,0,0.03); padding:12px; text-align:left; cursor:pointer; font-size:13px; }
tbody td{ padding:10px 12px; border-top:1px solid var(--border); font-size:13px; vertical-align:middle; }
.row-muted{ color:var(--muted); font-size:12px; }

/* small screens */
@media (max-width:880px){
  .input{ width:58%; min-width:120px; }
  .select{ width:40%; }
  .num{ width:44%; }
  thead th, tbody td{ padding:8px; font-size:12px; }
  table{ min-width:760px; }
}

/* loader */
#loader{ display:flex; align-items:center; gap:12px; color:var(--muted); margin:14px 0; }
.spinner{
  width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.08); border-top-color:var(--accent); animation:spin .9s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }

/* badge */
.badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; color:#fff; background:var(--accent); }

/* footer small note */
.footer-note{ margin-top:12px; color:var(--muted); font-size:12px; }
</style>
</head>
<body>

<h1>Chốt Công — WAREHOUSE RYOBI</h1>
<p class="desc">Dữ liệu load từ <code>dataWorker.js</code> (raw array hoặc biến JS). Tìm kiếm MSNV / Họ tên • Lọc theo Month / Team / Total OT / Total Leave • Click header để sort.</p>

<div class="toolbar">
  <input id="searchBox" class="input" placeholder="Tìm theo MSNV hoặc Họ Tên…" />
  <select id="filterMonth" class="select"><option value="">-- Lọc Month --</option></select>
  <select id="filterTeam" class="select"><option value="">-- Lọc Team --</option></select>
  <input id="minOT" class="num" placeholder="Min TOTAL OT" type="number" />
  <input id="maxOT" class="num" placeholder="Max TOTAL OT" type="number" />
  <input id="minLeave" class="num" placeholder="Min TOTAL Leave" type="number" />
  <input id="maxLeave" class="num" placeholder="Max TOTAL Leave" type="number" />
  <button id="clearFilters" class="btn secondary">Xóa lọc</button>
</div>

<div id="loader"><div class="spinner"></div><div>Đang tải dữ liệu…</div></div>

<div class="table-wrap" id="tableWrap" style="display:none;">
  <table id="dataTable" aria-describedby="footerNote">
    <thead>
      <tr>
        <th data-col="MSNV">MSNV ⬍</th>
        <th data-col="HoTen">Họ Tên ⬍</th>
        <th data-col="Team">Team ⬍</th>
        <th data-col="Month">Month ⬍</th>
        <th data-col="TotalWKD">TotalWKD ⬍</th>
        <th data-col="TotalOT">TotalOT ⬍</th>
        <th data-col="TotalLeave">TotalLeave ⬍</th>
        <th data-col="FromDate">FromDate ⬍</th>
        <th data-col="ToDate">ToDate ⬍</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="footer-note" id="footerNote">* Lọc & tìm kiếm thực hiện trên dữ liệu đã tải. Nếu dữ liệu không hiển thị, kiểm tra file <code>dataWorker.js</code> trong cùng thư mục.</div>

<!-- THEME LOADER (như bạn muốn: sẽ đọc theme/themeList.json nếu có) -->
<script>
async function loadTheme(){
  try{
    const r = await fetch("theme/themeList.json?v=" + Date.now());
    if(!r.ok) return;
    const cfg = await r.json();
    let active = cfg.activeTheme || "default";
    if(active === "auto"){
      const map = {1:"jan_newyear",2:"feb_valentine",3:"mar_womenday",4:"april30",5:"may_workers",6:"jun_summer",7:"jul_fireworks",8:"aug_sun",9:"sept2",10:"oct_halloween",11:"nov_remember",12:"dec_noel"};
      active = map[new Date().getMonth()+1] || "default";
    }
    if(active === "default") return;
    const tf = await fetch("theme/"+active+".json?v="+Date.now());
    if(!tf.ok) return;
    const theme = await tf.json();
    if(theme.background) document.body.style.background = theme.background;
    if(theme.textColor) document.body.style.color = theme.textColor;
    if(theme.uiColors){
      const s = document.createElement("style");
      s.innerHTML = `
        table{ background:${theme.uiColors.tableBg||"inherit"} !important; }
        table td, table th{ color:${theme.uiColors.tableText||"inherit"} !important; }
        thead th{ background:${theme.uiColors.tableHeaderBg||"inherit"} !important; }
      `;
      document.head.appendChild(s);
    }
    if(theme.music){
      const a = document.createElement("audio");
      a.src = "theme/" + theme.music; a.loop=true; a.autoplay=true; a.id="themeMusic"; a.style.display="none";
      document.body.appendChild(a);
    }
  }catch(e){ console.warn("Theme load:", e); }
}
loadTheme();
</script>

<!-- MAIN SCRIPT -->
<script>
/*
  Logic:
  1) fetch("dataWorker.js") -> text
     - if startsWith('[') => JSON.parse(text)
     - else insert script text to head -> expect window.dataWorker (or other names)
  2) render controls, fill select options
  3) apply filters & sort
*/

// Global
let RAW = [];
let currentSort = { col:null, asc:true };

// UTIL helpers
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function safeNum(v){
  if(v === null || v === undefined || v === "") return NaN;
  return Number(v);
}

// try to load dataWorker.js (raw array or var)
async function loadDataWorker(){
  try {
    const resp = await fetch("dataWorker.js?v=" + Date.now());
    const text = await resp.text();

    // clean BOM
    const t = text.replace(/^\uFEFF/, "").trim();

    if(t.startsWith("[")) {
      // raw JSON array
      try {
        const arr = JSON.parse(t.replace(/;\s*$/,""));
        RAW = Array.isArray(arr) ? arr : [];
        return;
      } catch(err){
        console.error("JSON parse error:", err);
        RAW = [];
        return;
      }
    }

    // else, try to evaluate as script but safely insert to DOM
    // We don't eval; we insert script element so that author-defined var becomes global.
    try {
      const s = document.createElement("script");
      s.type = "text/javascript";
      s.text = t;
      document.head.appendChild(s);
      // try common global names
      RAW = window.dataWorker || window.data || window.dataWorkers || window.__DATA__ || window.DATA || [];
      if(!Array.isArray(RAW)) RAW = [];
    } catch(e){
      console.error("Insert script error:", e);
      RAW = [];
    }
  } catch(e){
    console.error("Fetch dataWorker.js failed:", e);
    RAW = [];
  }
}

// render table rows
function renderTable(data){
  const tbody = $("#dataTable tbody");
  tbody.innerHTML = "";
  if(!data || data.length === 0){
    tbody.innerHTML = `<tr><td colspan="9" class="row-muted">Không có dữ liệu</td></tr>`;
    return;
  }
  // build rows
  for(const r of data){
    const msnv = r.MSNV ?? r.MSN ?? "";
    const name = r.HoTen ?? r.FullName ?? r.Fullname ?? r.FullNameVN ?? "";
    const team = r.Team ?? "";
    const month = r.Month ?? "";
    const wkd = r.TotalWKD ?? r["Tổng Ngày làm việc"] ?? "";
    const ot = r.TotalOT ?? r["TOTAL OT"] ?? r.TotalOT ?? "";
    const leave = r.TotalLeave ?? r["TOTAL Leave"] ?? "";
    const from = r.FromDate ?? r["From date"] ?? "";
    const to = r.ToDate ?? r["To date"] ?? "";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${escapeHtml(msnv)}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(team)}</td>
      <td>${escapeHtml(month)}</td>
      <td>${escapeHtml(wkd)}</td>
      <td>${escapeHtml(ot)}</td>
      <td>${escapeHtml(leave)}</td>
      <td>${escapeHtml(from)}</td>
      <td>${escapeHtml(to)}</td>
    `;
    tbody.appendChild(row);
  }
}

// escape to avoid injection
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// build filter options from RAW
function buildFilterOptions(){
  const monthSet = new Set();
  const teamSet = new Set();
  RAW.forEach(r=>{
    if(r.Month) monthSet.add(r.Month);
    if(r.Team) teamSet.add(r.Team);
  });
  const monthSel = $("#filterMonth");
  const teamSel = $("#filterTeam");
  // clear
  monthSel.innerHTML = `<option value="">-- Lọc Month --</option>`;
  teamSel.innerHTML = `<option value="">-- Lọc Team --</option>`;
  Array.from(monthSet).sort().forEach(m=> {
    const o = document.createElement("option"); o.value = m; o.textContent = m; monthSel.appendChild(o);
  });
  Array.from(teamSet).sort().forEach(t=> {
    const o = document.createElement("option"); o.value = t; o.textContent = t; teamSel.appendChild(o);
  });
}

// apply filters & search & sort
function applyFiltersAndRender(){
  let data = RAW.slice();

  // search
  const q = ($("#searchBox").value || "").toLowerCase().trim();
  if(q){
    data = data.filter(r=>{
      const msnv = String(r.MSNV ?? r.MSN ?? "").toLowerCase();
      const name = String(r.HoTen ?? r.FullName ?? r.Fullname ?? "").toLowerCase();
      return msnv.includes(q) || name.includes(q);
    });
  }

  // month filter
  const fM = $("#filterMonth").value;
  if(fM) data = data.filter(r => (r.Month||"") === fM);

  // team filter
  const fT = $("#filterTeam").value;
  if(fT) data = data.filter(r => (r.Team||"") === fT);

  // OT range
  const minOT = safeNum($("#minOT").value);
  const maxOT = safeNum($("#maxOT").value);
  if(!isNaN(minOT)) data = data.filter(r => (safeNum(r.TotalOT) >= minOT));
  if(!isNaN(maxOT)) data = data.filter(r => (safeNum(r.TotalOT) <= maxOT));

  // Leave range
  const minL = safeNum($("#minLeave").value);
  const maxL = safeNum($("#maxLeave").value);
  if(!isNaN(minL)) data = data.filter(r => (safeNum(r.TotalLeave) >= minL));
  if(!isNaN(maxL)) data = data.filter(r => (safeNum(r.TotalLeave) <= maxL));

  // sort
  if(currentSort.col){
    const col = currentSort.col;
    const asc = currentSort.asc ? 1 : -1;
    data.sort((a,b) => {
      const va = (a[col] === undefined ? "" : a[col]);
      const vb = (b[col] === undefined ? "" : b[col]);
      // try numeric
      const na = parseFloat(va);
      const nb = parseFloat(vb);
      if(!isNaN(na) && !isNaN(nb)) return (na - nb) * asc;
      // string compare
      return String(va).localeCompare(String(vb), "vi") * asc;
    });
  }

  renderTable(data);
}

// wire events
function wireEvents(){
  $("#searchBox").addEventListener("input", debounce(applyFiltersAndRender, 220));
  $("#filterMonth").addEventListener("change", applyFiltersAndRender);
  $("#filterTeam").addEventListener("change", applyFiltersAndRender);
  $("#minOT").addEventListener("input", debounce(applyFiltersAndRender, 200));
  $("#maxOT").addEventListener("input", debounce(applyFiltersAndRender, 200));
  $("#minLeave").addEventListener("input", debounce(applyFiltersAndRender, 200));
  $("#maxLeave").addEventListener("input", debounce(applyFiltersAndRender, 200));
  $("#clearFilters").addEventListener("click", () => {
    $("#searchBox").value = "";
    $("#filterMonth").value = "";
    $("#filterTeam").value = "";
    $("#minOT").value = "";
    $("#maxOT").value = "";
    $("#minLeave").value = "";
    $("#maxLeave").value = "";
    currentSort = {col:null,asc:true};
    applyFiltersAndRender();
  });

  // header sort
  $$("#dataTable thead th").forEach(th => {
    th.addEventListener("click", () => {
      const col = th.getAttribute("data-col");
      if(!col) return;
      if(currentSort.col === col) currentSort.asc = !currentSort.asc;
      else { currentSort.col = col; currentSort.asc = true; }
      applyFiltersAndRender();
    });
  });
}

// debounce
function debounce(fn, t=200){ let h; return (...a)=>{ clearTimeout(h); h = setTimeout(()=>fn(...a), t); }; }

// entry
(async function init(){
  // show loader
  $("#loader").style.display = "flex";
  await loadDataWorker();
  // hide loader
  $("#loader").style.display = "none";
  // show table
  $("#tableWrap").style.display = "block";

  buildFilterOptions();
  wireEvents();
  applyFiltersAndRender();
})();

// expose refresh for debug
window.__refreshData = async function(){
  $("#loader").style.display = "flex";
  await loadDataWorker();
  $("#loader").style.display = "none";
  buildFilterOptions();
  applyFiltersAndRender();
};
</script>
</body>
</html>
