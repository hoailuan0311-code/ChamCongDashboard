<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chốt Công — WAREHOUSE RYOBI</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ========== THEME (dark auto) ========== */
:root{
  --bg:#f5f7fa; --text:#111; --box:#fff; --muted:#666; --accent:#00bcd4; --border:#e6e6e6;
  --table-text-light:#06212a;
  --table-text-dark:#ffffff;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0f1113; --text:#e6eef6; --box:#141518; --muted:#9aa3ad; --accent:#2ec4d6; --border:#222427; }
}

/* Base */
*{box-sizing:border-box}
body{
  margin:18px; font-family:"Be Vietnam Pro",sans-serif;
  background:var(--bg); color:var(--text);
}

/* Header */
h1{
  font-size:32px; margin:0 0 6px; font-weight:800;
  background:linear-gradient(90deg,#4facfe,#00f2fe);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
p.desc{ margin:4px 0 16px; color:var(--muted); }

/* Toolbar */
.toolbar{
  display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px;
}
.input, .select{
  padding:12px 14px; border-radius:12px;
  border:1px solid var(--border);
  background:var(--box); color:var(--text);
}
.input{ min-width:260px; width:36%; font-size:15px; }
.select{ min-width:160px; font-size:14px; }

.btn{
  padding:10px 14px; border-radius:12px; border:none;
  cursor:pointer; font-weight:700; color:#022;
  background:linear-gradient(135deg,#4facfe,#00f2fe);
}

/* Table container */
.table-wrap{
  overflow:auto; border-radius:12px; background:var(--box);
  box-shadow:0 12px 30px rgba(0,0,0,0.06);
  border:1px solid var(--border);
  height:70vh;
}

/* Table */
table{ width:100%; border-collapse:collapse; min-width:980px; }

thead th{
  position:sticky; top:0; z-index:5;
  background:rgba(0,0,0,0.04);
  padding:12px; text-align:left; cursor:pointer; font-size:13px;
}

tbody td{
  padding:12px; border-top:1px solid var(--border);
  font-size:13px;
  transition:transform .18s, box-shadow .18s, background .12s;
  color:var(--table-text-light);
}

@media (prefers-color-scheme: dark){
  tbody td{ color:var(--table-text-dark) !important; }
  thead th{ color:#fff !important; }
}

tbody tr:hover td{
  transform:translateY(-4px);
  background:rgba(255,255,255,0.03);
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}

/* Loader */
#loader{
  display:flex; align-items:center;
  gap:12px; margin:14px 0; color:var(--muted);
}
.spinner{
  width:18px;height:18px; border-radius:50%;
  border:3px solid rgba(0,0,0,0.08);
  border-top-color:var(--accent);
  animation:spin .9s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

.fade-in{
  animation:fadeIn .35s ease;
}
@keyframes fadeIn{
  from{ opacity:0; transform:translateY(8px); }
  to{ opacity:1; transform:translateY(0); }
}

.footer-note{
  margin-top:12px; color:var(--muted); font-size:12px;
}

/* Override theme text */
@media (prefers-color-scheme: dark){
  #dataTable td,#dataTable th{ color:#fff !important; }
}
@media (prefers-color-scheme: light){
  #dataTable td,#dataTable th{ color:#06212a !important; }
}
</style>
</head>

<body>

<h1>Chốt Công — WAREHOUSE RYOBI</h1>
<p class="desc">Infinite scroll • Serial date → dd-mm-yyyy • Sort • Filter • Search • Auto Theme</p>

<div class="toolbar">
  <input id="searchBox" class="input" placeholder="Tìm theo MSNV hoặc Họ Tên…" />
  <select id="filterMonth" class="select">
    <option value="">-- Lọc Month --</option>
  </select>

  <select id="filterTeam" class="select">
    <option value="">-- Lọc Team --</option>
  </select>

  <button id="clearFilters" class="btn">Xóa lọc</button>
</div>

<div id="loader">
  <div class="spinner"></div>
  <div>Đang tải dữ liệu…</div>
</div>

<div class="table-wrap" id="tableWrap" style="display:none;">
  <table id="dataTable">
    <thead>
      <tr>
        <th data-col="MSNV">MSNV</th>
        <th data-col="HoTen">Họ Tên</th>
        <th data-col="Team">Team</th>
        <th data-col="Month">Month</th>
        <th data-col="TotalWKD">Total WKD</th>
        <th data-col="TotalOT">Total OT</th>
        <th data-col="TotalLeave">Total Leave</th>
        <th data-col="FromDate">From Date</th>
        <th data-col="ToDate">To Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="footer-note">
  Tự động tải thêm khi cuộn • 50 dòng mỗi batch
</div>

<!-- THEME LOADER -->
<script>
async function loadTheme(){
  try{
    const r = await fetch("theme/themeList.json?v="+Date.now());
    const cfg = await r.json();

    let active = cfg.activeTheme || "default";

    if(active==="auto"){
      const m = new Date().getMonth()+1;
      const map={
        1:"jan_newyear",2:"feb_valentine",3:"mar_womenday",4:"april30",5:"may_workers",
        6:"jun_summer",7:"jul_fireworks",8:"aug_sun",9:"sept2",10:"oct_halloween",
        11:"nov_remember",12:"dec_noel"
      };
      active = map[m] || "default";
    }

    if(active==="default") return;

    const themeFile = await fetch(`theme/${active}.json?v=${Date.now()}`);
    const theme = await themeFile.json();

    if(theme.background) document.body.style.background = theme.background;
    if(theme.textColor) document.body.style.color = theme.textColor;
    if(theme.font) document.body.style.fontFamily = theme.font;

    if(theme.uiColors){
      const s=document.createElement("style");
      s.innerHTML = `
        table{ background:${theme.uiColors.tableBg||"inherit"} !important; }
        th,td{ color:${theme.uiColors.tableText||"inherit"} !important; }
      `;
      document.head.appendChild(s);
    }

    if(theme.music){
      const a=document.createElement("audio");
      a.src="theme/"+theme.music;
      a.autoplay=true; a.loop=true; a.volume=0.45;
      a.style.display="none";
      document.body.appendChild(a);
    }

    if(theme.effect){
      const e=document.createElement("script");
      e.src="theme/"+theme.effect;
      document.body.appendChild(e);
    }
  }catch(e){
    console.warn("Theme load error:", e);
  }
}
loadTheme();
</script>

<!-- MAIN SCRIPT — INFINITE SCROLL -->
<script>
const BATCH = 50;

let RAW = [];
let filtered = [];
let loadedCount = 0;
let currentSort = { col:null, asc:true };

const $ = s => document.querySelector(s);

/* Convert Excel serial → dd-mm-yyyy */
function excelSerialToDate(serial){
  if(!serial || isNaN(serial)) return "";
  const date = new Date((serial - 25569) * 86400 * 1000);
  if(isNaN(date)) return "";
  let d = String(date.getDate()).padStart(2,"0");
  let m = String(date.getMonth()+1).padStart(2,"0");
  let y = date.getFullYear();
  return `${d}-${m}-${y}`;
}

/* Escape HTML */
function escapeHtml(s){
  if(s==null) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;");
}

/* Load dataWorker.js */
async function loadDataWorker(){
  try{
    const txt = await (await fetch("dataWorker.js?v="+Date.now())).text();
    const t = txt.trim();

    if(t.startsWith("[")){
      RAW = JSON.parse(t.replace(/;$/,""));
      return;
    }

    const s=document.createElement("script");
    s.text = t;
    document.head.appendChild(s);

    RAW = window.dataWorker || window.data || window.DATA || [];
    if(!Array.isArray(RAW)) RAW=[];
  }catch(e){
    console.error("Load data error:",e);
    RAW=[];
  }
}

/* Build filters */
function buildFilters(){
  const mSet=new Set(), tSet=new Set();
  RAW.forEach(r=>{
    if(r.Month) mSet.add(r.Month);
    if(r.Team) tSet.add(r.Team);
  });

  const mSel=$("#filterMonth"), tSel=$("#filterTeam");
  mSel.innerHTML=`<option value="">-- Lọc Month --</option>`;
  tSel.innerHTML=`<option value="">-- Lọc Team --</option>`;

  [...mSet].sort().forEach(x=>mSel.innerHTML+=`<option>${x}</option>`);
  [...tSet].sort().forEach(x=>tSel.innerHTML+=`<option>${x}</option>`);
}

/* Apply filter + sort */
function applyFilters(){
  const q = $("#searchBox").value.toLowerCase().trim();
  const fm=$("#filterMonth").value;
  const ft=$("#filterTeam").value;

  let data = RAW.slice();

  if(q){
    data = data.filter(r=>{
      const ms=String(r.MSNV||"").toLowerCase();
      const nm=String(r.HoTen||r.FullName||"").toLowerCase();
      return ms.includes(q) || nm.includes(q);
    });
  }

  if(fm) data = data.filter(r=>r.Month===fm);
  if(ft) data = data.filter(r=>r.Team===ft);

  if(currentSort.col){
    const col=currentSort.col, asc=currentSort.asc?1:-1;
    data.sort((a,b)=>{
      let va=a[col], vb=b[col];
      const na=parseFloat(va), nb=parseFloat(vb);
      if(!isNaN(na)&&!isNaN(nb)) return (na-nb)*asc;
      return String(va).localeCompare(String(vb),'vi')*asc;
    });
  }

  filtered = data;
  loadedCount = 0;

  $("#dataTable tbody").innerHTML="";
  loadMoreRows();
}

/* Load more rows when scrolling */
function loadMoreRows(){
  if(loadedCount >= filtered.length) return;

  const tbody=$("#dataTable tbody");
  const end = Math.min(loadedCount + BATCH, filtered.length);

  for(let i=loadedCount; i<end; i++){
    const r = filtered[i];

    const tr=document.createElement("tr");
    tr.classList.add("fade-in");

    tr.innerHTML = `
      <td>${escapeHtml(r.MSNV)}</td>
      <td>${escapeHtml(r.HoTen||r.FullName||"")}</td>
      <td>${escapeHtml(r.Team)}</td>
      <td>${escapeHtml(r.Month)}</td>
      <td>${escapeHtml(r.TotalWKD)}</td>
      <td>${escapeHtml(r.TotalOT)}</td>
      <td>${escapeHtml(r.TotalLeave)}</td>
      <td>${excelSerialToDate(r.FromDate ?? r["From date"])}</td>
      <td>${excelSerialToDate(r.ToDate   ?? r["To date"])}</td>
    `;
    tbody.appendChild(tr);
  }

  loadedCount = end;
}

/* Infinite scroll */
function setupInfiniteScroll(){
  const wrap=$("#tableWrap");
  wrap.addEventListener("scroll",()=>{
    if(wrap.scrollTop + wrap.clientHeight >= wrap.scrollHeight - 120){
      loadMoreRows();
    }
  });
}

/* Sorting */
function setupSort(){
  document.querySelectorAll("#dataTable thead th").forEach(th=>{
    th.addEventListener("click",()=>{
      const col=th.dataset.col;
      if(!col) return;
      if(currentSort.col===col) currentSort.asc=!currentSort.asc;
      else{ currentSort.col=col; currentSort.asc=true; }
      applyFilters();
    });
  });
}

/* Events */
function setupEvents(){
  $("#searchBox").addEventListener("input",()=>applyFilters());
  $("#filterMonth").addEventListener("change",()=>applyFilters());
  $("#filterTeam").addEventListener("change",()=>applyFilters());

  $("#clearFilters").addEventListener("click",()=>{
    $("#searchBox").value="";
    $("#filterMonth").value="";
    $("#filterTeam").value="";
    currentSort={col:null,asc:true};
    applyFilters();
  });
}

/* INIT */
(async function init(){
  await loadDataWorker();
  buildFilters();
  setupSort();
  setupEvents();
  setupInfiniteScroll();

  $("#loader").style.display="none";
  $("#tableWrap").style.display="block";
  applyFilters();
})();
</script>

</body>
</html>
