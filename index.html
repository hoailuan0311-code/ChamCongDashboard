<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>üìÖ Dashboard ‚Äì WAREHOUSE RYOBI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Font ti·∫øng Vi·ªát -->
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* ===================== DARK MODE AUTO ===================== */
:root {
    --bg: #f5f7fa;
    --text: #111;
    --box: #fff;
    --box-border: #ddd;
}
@media (prefers-color-scheme: dark) {
    :root {
        --bg: #121212;
        --text: #eee;
        --box: #1e1e1e;
        --box-border: #333;
    }
}

/* ===================== GLOBAL ===================== */
body {
    background: var(--bg);
    color: var(--text);
    font-family: "Be Vietnam Pro", sans-serif;
    margin: 20px;
    transition: background 0.3s, color 0.3s;
}

/* ===================== TITLE ===================== */
h1 {
    text-align: center;
    font-size: 42px;
    font-weight: 800;
    margin-bottom: 10px;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 12px rgba(0,255,255,0.25);
}

h2 { margin-top: 25px; }

/* ===================== SEARCH / BUTTONS ===================== */
.search-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 6px;
}

/* g·ªôp 2 √¥ th√†nh 1, thu g·ªçn */
.search-bar input {
    padding: 10px 14px;
    width: 7%;                /* nh·ªè l·∫°i theo y√™u c·∫ßu ‚Äî ch·ªânh n·∫øu mu·ªën */
    min-width: 220px;
    border-radius: 10px;
    border: 1px solid var(--box-border);
    background: var(--box);
    color: var(--text);
    font-size: 11px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.04);
}

/* chung cho c√°c n√∫t h√†nh ƒë·ªông */
.btn {
    padding: 12px 18px;
    border-radius: 12px;
    cursor: pointer;
    border: none;
    font-weight: 700;
    color: #fff;
    box-shadow: 0 10px 24px rgba(0,0,0,0.08);
    transition: transform .15s, box-shadow .15s;
}
.btn:hover { transform: translateY(-3px); }

/* ri√™ng c√°c n√∫t m√†u */
.btn-feedback { background: linear-gradient(135deg,#9fbdfb,#d6bffd); color:#063; }
.btn-qa { background: linear-gradient(135deg,#16a085,#27ae60); }
.btn-pass { background: linear-gradient(135deg,#16a085,#27ae60); } /* Qu√™n Pass */
.btn-viewpass { background: linear-gradient(135deg,#8e44ad,#9b59b6); }
.btn-chot { background: linear-gradient(135deg,#f59f00,#f08b00); } /* Xem Ch·ªët C√¥ng */
.btn-late { background: linear-gradient(135deg,#d43d2a,#c33a2a); box-shadow:0 14px 36px rgba(196,57,57,0.2); }

/* tweak nh·ªè cho h√†ng n√∫t khi co nh·ªè m√†n h√¨nh */
@media (max-width: 880px) {
    .search-bar input { width: 60%; }
    .btn { padding: 10px 12px; font-size: 14px; }
}

/* ===================== TABLE ===================== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: var(--box);
    border-radius: 12px;
    overflow: hidden;
}

th, td {
    padding: 10px;
    border-bottom: 1px solid var(--box-border);
}

th {
    background: rgba(0,0,0,0.05);
    cursor: pointer;
}

/* Badge */
.badge {
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    color: #fff;
}
.confirm-none { background: #ff6b6b; }
.confirm-done { background: #2ecc71; }

/* ===================== CHART BOXES ===================== */
.chart-box {
    background: var(--box);
    padding: 15px;
    border-radius: 12px;
    margin-top: 20px;
    border: 1px solid var(--box-border);
}

.footer-layout {
    display: grid;
    gap: 20px;
}

.footer-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
}

.full-row { grid-column: 1 / -1; }

/* ===================== AUDIO ===================== */
audio { display: none; }

</style>
</head>

<body>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng ‚Äì WAREHOUSE RYOBI</h1>

<p>üïì D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông ‚ù§Ô∏èü´∂‚ù§Ô∏è</p>

<!-- SEARCH + ACTIONS -->
<div class="search-bar">
    <!-- G·ªôp 2 √¥ th√†nh 1 -->
    <input id="searchBox" placeholder="T√¨m theo MSNV ho·∫∑c H·ªç T√™n‚Ä¶">

    <button id="feedbackBtn" class="btn btn-feedback">üìù Ph·∫£n h·ªìi ch·∫•m c√¥ng</button>

    <!-- Qu√™n Pass CADENA (r√∫t g·ªçn) -->
    <button id="passBtn" class="btn btn-pass">üîê Qu√™n Pass CADENA</button>

    <!-- Xem Pass CADENA -->
    <button id="viewPassBtn" class="btn btn-viewpass">üìÅ Xem Pass CADENA</button>

    <!-- Xem Ch·ªët C√¥ng (m·ªõi) -->
    <button id="viewChotBtn" class="btn btn-chot">üìä Xem Ch·ªët C√¥ng</button>

    <!-- Late / Out / Missing (m·ªõi) -->
    <button id="lateBtn" class="btn btn-late">‚è±Ô∏è Late ‚Ä¢ Out ‚Ä¢ Missing</button>
</div>

<h2>Danh s√°ch chi ti·∫øt</h2>

<table id="dataTable">
    <thead>
        <tr>
            <th onclick="sortBy('MSNV')">MSNV ‚¨ç</th>
            <th>H·ªç t√™n</th>
            <th onclick="sortBy('NgayDieuChinh')">Ng√†y ƒëi·ªÅu ch·ªânh ‚¨ç</th>
            <th>N·ªôi dung</th>
            <th>Confirm</th>
            <th>BU</th>
            <th>Team</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- FOOTER CHARTS -->
<h2>Bi·ªÉu ƒë·ªì ph·ª•</h2>

<div class="footer-layout">
    <div class="footer-row">
        <div class="chart-box">
            <h3>Theo BU</h3>
            <canvas id="chartBU"></canvas>
        </div>

        <div class="chart-box">
            <h3>Theo Team</h3>
            <canvas id="chartTeam"></canvas>
        </div>
    </div>

    <div class="chart-box full-row">
        <h3>Top ph·∫£n h·ªìi</h3>
        <canvas id="chartTop"></canvas>
    </div>

    <div class="chart-box full-row">
        <h3>Theo ng√†y ch·ªânh</h3>
        <canvas id="chartNgay"></canvas>
    </div>
</div>

<!-- Background Music -->
<audio id="bgMusic" loop>
    <source src="NhacGiangSinh.mp3" type="audio/mpeg">
</audio>


<!-- ===================== SCRIPT g·ªëc c·ªßa b·∫°n (kh√¥ng ph√° c·∫•u tr√∫c) ===================== -->
<script>
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";
let fullData = [];

/* LOAD DATA */
async function loadData(){
    try {
        let res = await fetch(jsonUrl + "?cache=" + Date.now());
        fullData = await res.json();
        renderAll(fullData);
    } catch (e) {
        console.error("Load data error:", e);
        fullData = [];
        renderAll(fullData);
    }
}
loadData();

/* FORMAT DATE */
function excelDate(v){
    if (!v) return "";
    const d = new Date((v - 25569) * 86400 * 1000);
    return isNaN(d) ? v : d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
}

/* SEARCH (d√πng √¥ g·ªôp) */
document.getElementById("searchBox").addEventListener("input", applySearch);

function applySearch(){
    const q = (document.getElementById("searchBox").value || "").toLowerCase().trim();

    // n·∫øu r·ªóng => hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
    if(!q){
        renderAll(fullData);
        return;
    }

    const f = fullData.filter(r =>
        (("" + (r.MSNV||"")).toLowerCase().includes(q)) ||
        (("" + (r.FullName||"")).toLowerCase().includes(q))
    );

    renderAll(f);
}

/* SORT (gi·ªØ nguy√™n) */
function sortBy(col){
    fullData.sort((a,b)=> (a[col] > b[col] ? 1 : -1));
    renderAll(fullData);
}

/* RENDER TABLE (gi·ªØ nguy√™n nh∆∞ng an to√†n n·∫øu data r·ªóng) */
function renderTable(data){
    let tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    if(!data || data.length === 0){
        // gi·ªØ header nh∆∞ng show h√†ng tr·ªëng (nh∆∞ b·∫£n g·ªëc)
        return;
    }

    data.forEach(r=>{
        tbody.insertAdjacentHTML("beforeend", `
        <tr>
            <td>${r.MSNV || ""}</td>
            <td>${r.FullName || ""}</td>
            <td>${excelDate(r.NgayDieuChinh)}</td>
            <td>${r.NoiDung || ""}</td>
            <td><span class="badge ${r.ConfirmAdmin ? "confirm-done":"confirm-none"}">
                ${r.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
            </span></td>
            <td>${r.BU || ""}</td>
            <td>${r.Team || ""}</td>
        </tr>
        `);
    });
}

/* RENDER ALL */
function renderAll(data){
    renderTable(data);
    renderBU(data);
    renderTeam(data);
    renderTop(data);
    renderNgay(data);
}

/* CHART FUNCTIONS (gi·ªØ nguy√™n) */
Chart.register(ChartDataLabels);

function renderBU(data){
    const c = {};
    data.forEach(r => c[r.BU] = (c[r.BU] || 0) + 1);

    // cleanup old canvas if exists to avoid duplicates
    if(window._chartBU) window._chartBU.destroy?.();

    window._chartBU = new Chart(document.getElementById("chartBU"), {
        type: "pie",
        data: { labels: Object.keys(c), datasets: [{ data:Object.values(c), backgroundColor:["#ff6384","#36a2eb"] }]},
        plugins: [ChartDataLabels],
        options:{
            animation:{ duration:1200, easing:"easeOutBounce" },
            plugins:{ datalabels:{ color:"#fff", font:{weight:"bold"} } }
        }
    });
}

function renderTeam(data){
    const c = {};
    data.forEach(r => c[r.Team] = (c[r.Team] || 0) + 1);

    if(window._chartTeam) window._chartTeam.destroy?.();

    window._chartTeam = new Chart(document.getElementById("chartTeam"),{
        type:"bar",
        data:{
            labels:Object.keys(c),
            datasets:[{ data:Object.values(c), backgroundColor:"#ffa64d" }]
        },
        plugins:[ChartDataLabels],
        options:{
            animation:{ duration:1200, easing:"easeOutElastic" },
            plugins:{ datalabels:{ anchor:"end", align:"top", color:"#fff", font:{weight:"bold"} } }
        }
    });
}

function renderTop(data){
    const c = {};
    data.forEach(r => c[r.FullName] = (c[r.FullName]||0)+1);

    let sorted = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);

    if(window._chartTop) window._chartTop.destroy?.();

    window._chartTop = new Chart(document.getElementById("chartTop"),{
        type:"bar",
        data:{
            labels:sorted.map(x=>x[0]),
            datasets:[{ data:sorted.map(x=>x[1]), backgroundColor:"#00c9ff" }]
        },
        plugins:[ChartDataLabels],
        options:{
            animation:{ duration:1400, easing:"easeOutQuad" },
            plugins:{ datalabels:{ anchor:"end", align:"top", color:"#fff", font:{weight:"bold"} } }
        }
    });
}

function renderNgay(data){
    const c = {};
    data.forEach(r => {
        let d = excelDate(r.NgayDieuChinh);
        c[d] = (c[d]||0)+1;
    });

    if(window._chartNgay) window._chartNgay.destroy?.();

    window._chartNgay = new Chart(document.getElementById("chartNgay"),{
        type:"bar",
        data:{
            labels:Object.keys(c),
            datasets:[{ data:Object.values(c), backgroundColor:"#9b59b6" }]
        },
        plugins:[ChartDataLabels],
        options:{
            animation:{ duration:1500, easing:"easeOutBounce" },
            plugins:{ datalabels:{ anchor:"end", align:"top", color:"#fff", font:{weight:"bold"} } }
        }
    });
}

/* BUTTON ACTIONS (gi·ªØ c√°c link g·ªëc, 2 n√∫t m·ªõi m·ªü placeholder) */
document.getElementById("feedbackBtn").addEventListener("click", () => {
    window.open("https://forms.office.com/r/wSm7WHpgCw", "_blank");
});

document.getElementById("passBtn").addEventListener("click", () => {
    window.open("https://forms.office.com/r/wMUXy1P6P1", "_blank"); // ch·ªânh n·∫øu mu·ªën kh√°c
});

document.getElementById("viewPassBtn").addEventListener("click", () => {
    window.open("passCadena.html", "_blank");
});

// n√∫t m·ªõi: Xem Ch·ªët C√¥ng ‚Äî b·∫°n s·∫Ω add link sau
document.getElementById("viewChotBtn").addEventListener("click", () => {
    // ƒë·∫∑t URL th·∫≠t ·ªü ƒë√¢y khi c√≥
    window.open("#", "_blank");
});

// n√∫t m·ªõi: Late ‚Ä¢ Out ‚Ä¢ Missing ‚Äî b·∫°n s·∫Ω add link sau
document.getElementById("lateBtn").addEventListener("click", () => {
    window.open("#", "_blank");
});

/* MUSIC (gi·ªØ) */
document.addEventListener("click", ()=> {
    try { document.getElementById("bgMusic").play(); } catch(e){}
}, {once:true});
document.addEventListener("touchstart", ()=> {
    try { document.getElementById("bgMusic").play(); } catch(e){}
}, {once:true});
</script>

<!-- ===================== THEME LOADER (FINAL + AUTO MONTH) ===================== -->
<script>
async function loadTheme() {
    try {
        // Load c·∫•u h√¨nh
        const cfgResp = await fetch("theme/themeList.json?v=" + Date.now());
        const cfg = await cfgResp.json();

        let activeTheme = cfg.activeTheme || "default";

        // ================== AUTO THEME THEO TH√ÅNG ==================
        // Th√°ng JS: 0 = Jan ‚Üí 11 = Dec
        const month = new Date().getMonth() + 1; // ƒë·ªïi v·ªÅ 1‚Äì12 cho kh·ªõp file b·∫°n g·ª≠i

        const map = {
            1: "jan_newyear",
            2: "feb_valentine",
            3: "mar_womenday",
            4: "april30",
            5: "may_workers",
            6: "jun_summer",
            7: "jul_fireworks",
            8: "aug_sun",
            9: "sept2",
            10: "oct_halloween",
            11: "nov_remember",
            12: "dec_noel"
        };

        // N·∫øu c·∫•u h√¨nh ghi activeTheme = "auto" ‚Üí k√≠ch ho·∫°t auto theo th√°ng
        if (activeTheme === "auto") {
            activeTheme = map[month] || "default";
            console.log("AUTO THEME:", "month =", month, "‚Üí theme =", activeTheme);
        }

        // N·∫øu theme = default ‚Üí gi·ªØ nguy√™n UI, tho√°t s·ªõm
        if (activeTheme === "default") {
            console.log("Theme default ‚Üí gi·ªØ giao di·ªán g·ªëc");
            return;
        }

        // ================== LOAD FILE THEME ==================
        const themeFile = await fetch(`theme/${activeTheme}.json?v=` + Date.now());
        if (!themeFile.ok) {
            console.warn("Kh√¥ng t√¨m th·∫•y theme:", activeTheme);
            return;
        }

        const theme = await themeFile.json();

        if (!theme.override) {
            console.log("Theme override = false ‚Üí gi·ªØ layout g·ªëc");
            return;
        }

        // ================== APPLY UI ==================
        if (theme.background) document.body.style.background = theme.background;
        if (theme.textColor) document.body.style.color = theme.textColor;
        if (theme.font) document.body.style.fontFamily = theme.font;

        // ================== UI COLOR OVERRIDE (table, card, header) ==================
        if (theme.uiColors) {
            const s = document.createElement("style");
            s.id = "theme-ui";
            s.innerHTML = `
                table { background:${theme.uiColors.tableBg || "inherit"} !important; }
                table td, table th { color:${theme.uiColors.tableText || "inherit"} !important; }
                th { background:${theme.uiColors.tableHeaderBg || "inherit"} !important; }
                .chart-box { 
                    background:${theme.uiColors.cardBg || "inherit"} !important;
                    border-color:${theme.uiColors.boxBorder || "inherit"} !important;
                }
            `;
            document.head.appendChild(s);
        }

        // ================== MUSIC ==================
        if (theme.music) {
            if (!document.getElementById("themeMusic")) {
                const audio = document.createElement("audio");
                audio.src = "theme/" + theme.music;
                audio.id = "themeMusic";
                audio.autoplay = true;
                audio.loop = true;
                audio.volume = 0.45;
                audio.style.display = "none";
                document.body.appendChild(audio);
            }
        }

        // ================== EFFECT SCRIPT ==================
        if (theme.effect) {
            const eff = document.createElement("script");
            eff.src = "theme/" + theme.effect;
            eff.defer = true;
            document.body.appendChild(eff);
        }

        console.log("‚úî Theme applied:", activeTheme);

    } catch (err) {
        console.error("Theme load error:", err);
    }
}

loadTheme();
</script>

</body>
</html>
