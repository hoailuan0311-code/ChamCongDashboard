<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial; margin: 20px; background: #fafafa; }
    h2 { margin-top: 30px; }
    .row-charts { display: flex; gap: 15px; margin-top: 25px; }
    .chart-box { 
        background: white; 
        padding: 12px; 
        border-radius: 10px; 
        flex: 1; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 260px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; font-size: 14px; }
    th { background: #f0f0f0; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; }
    .confirm-none { background: #ffe3e3; color: #c00; }
    .confirm-done { background: #d4ffe3; color: #007a2f; }
    input { padding: 8px; width: 250px; margin-right: 10px; }
</style>
</head>

<body>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</h1>
<p>üìå D·ªØ li·ªáu auto update t·ª´ PH·∫¢N H·ªíI CH·∫§M C√îNG.</p>

<!-- √î t√¨m ki·∫øm -->
<div>
    <input id="searchMSNV" placeholder="T√¨m theo MSNV‚Ä¶" />
    <input id="searchName" placeholder="T√¨m theo h·ªç t√™n‚Ä¶" />
    <button onclick="applySearch()">L·ªçc</button>
</div>

<!-- Danh s√°ch chi ti·∫øt -->
<h2>Danh s√°ch chi ti·∫øt</h2>
<table id="dataTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>MSNV</th>
            <th>H·ªç t√™n</th>
            <th>Ng√†y c·∫ßn ƒëi·ªÅu ch·ªânh</th>
            <th>N·ªôi dung</th>
            <th>Email</th>
            <th>Confirm Admin</th>
            <th>BU</th>
            <th>Team</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- 4 bi·ªÉu ƒë·ªì nh·ªè n·∫±m h√†ng ngang -->
<h2>Th·ªëng k√™</h2>

<div class="row-charts">
    <div class="chart-box">
        <h4>T·ªïng quan</h4>
        <canvas id="chartDays"></canvas>
    </div>

    <div class="chart-box">
        <h4>Top ph·∫£n h·ªìi</h4>
        <canvas id="chartTop"></canvas>
    </div>

    <div class="chart-box">
        <h4>Theo BU</h4>
        <canvas id="chartBU"></canvas>
    </div>

    <div class="chart-box">
        <h4>Theo Team</h4>
        <canvas id="chartTeam"></canvas>
    </div>
</div>

<script>
// === JSON URL ===
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";

// --- Convert Excel serial date ‚Üí dd-MMM-yyyy ---
function excelDateToString(v) {
    if (!v) return "";
    let d = new Date((v - 25569) * 86400 * 1000);
    if (isNaN(d)) return v;
    return d.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
}

let fullData = [];

// ===== LOAD JSON =====
async function loadData() {
    try {
        let res = await fetch(jsonUrl + "?cache=" + Date.now());
        fullData = await res.json();
        renderAll(fullData);
    } catch (e) {
        console.error("Load JSON l·ªói:", e);
    }
}

// ===== RENDER T·∫§T C·∫¢ =====
function renderAll(data) {
    renderTable(data);
    renderSummary(data);
    renderTopFeedback(data);
    renderBU(data);
    renderTeam(data);
}

// ===== TABLE =====
function renderTable(data) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
        tbody.innerHTML += `
        <tr>
            <td>${excelDateToString(row.Date)}</td>
            <td>${row.MSNV || ""}</td>
            <td>${row.FullName || ""}</td>
            <td>${excelDateToString(row.NgayDieuChinh)}</td>
            <td>${row.NoiDung || ""}</td>
            <td>${row.Email || ""}</td>
            <td>
                <span class="badge ${row.ConfirmAdmin ? "confirm-done" : "confirm-none"}">
                    ${row.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
                </span>
            </td>
            <td>${row.BU || ""}</td>
            <td>${row.Team || ""}</td>
        </tr>`;
    });
}

// ===== SEARCH =====
function applySearch() {
    let msnv = document.getElementById("searchMSNV").value.trim().toLowerCase();
    let name = document.getElementById("searchName").value.trim().toLowerCase();

    let filtered = fullData.filter(r =>
        (msnv === "" || (r.MSNV || "").toLowerCase().includes(msnv)) &&
        (name === "" || (r.FullName || "").toLowerCase().includes(name))
    );

    renderAll(filtered);
}

// ===== BI·ªÇU ƒê·ªí NG√ÄY =====
function renderSummary(data) {
    const counts = {};
    data.forEach(r => {
        let d = excelDateToString(r.Date);
        counts[d] = (counts[d] || 0) + 1;
    });

    new Chart(document.getElementById("chartDays"), {
        type: "bar",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                label: "S·ªë ph·∫£n h·ªìi",
                data: Object.values(counts),
                backgroundColor: "#4C8BF5"
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// ===== TOP FEEDBACK =====
function renderTopFeedback(data) {
    const counts = {};
    data.forEach(r => counts[r.FullName] = (counts[r.FullName] || 0) + 1);

    let sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,10);

    new Chart(document.getElementById("chartTop"), {
        type: "bar",
        data: {
            labels: sorted.map(x => x[0]),
            datasets: [{
                label: "S·ªë ph·∫£n h·ªìi",
                data: sorted.map(x => x[1]),
                backgroundColor: "#00AEEF"
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// ===== BU =====
function renderBU(data) {
    const counts = {};
    data.forEach(r => counts[r.BU] = (counts[r.BU] || 0) + 1);

    new Chart(document.getElementById("chartBU"), {
        type: "pie",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                data: Object.values(counts),
                backgroundColor: ["#FF6384","#36A2EB","#FFCE56","#66BB6A","#BA68C8"]
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// ===== TEAM =====
function renderTeam(data) {
    const counts = {};
    data.forEach(r => counts[r.Team] = (counts[r.Team] || 0) + 1);

    new Chart(document.getElementById("chartTeam"), {
        type: "pie",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                data: Object.values(counts),
                backgroundColor: ["#29B6F6","#FF7043","#9CCC65","#AB47BC","#FFD54F"]
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

loadData();
</script>

</body>
</html>
