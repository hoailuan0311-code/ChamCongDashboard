<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>üîê Pass CADENA ƒë√£ c·∫•p</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:"Be Vietnam Pro",sans-serif;background:#f1f5f9;padding:24px}
  h1{text-align:center;color:#00aaff;font-size:40px;margin:6px 0 10px;font-weight:800}
  #unlockBtn{display:block;margin:12px auto;padding:12px 32px;background:linear-gradient(135deg,#a78bfa,#818cf8);color:#fff;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  #lockNotice{text-align:center;color:#666;margin-bottom:12px}
  #searchBox{display:block;margin:10px auto 18px;padding:10px 14px;width:360px;border-radius:10px;border:1px solid #ddd}

  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:12px;border-bottom:1px solid #eee;text-align:left}
  th{background:#f8fafc;font-weight:700}

  .pending{background:#fcd34d;color:#422;padding:6px 12px;border-radius:10px;animation:blink 1.2s infinite}
  .done{background:#4ade80;color:#062;padding:6px 12px;border-radius:10px}

  @keyframes blink{50%{opacity:.4}}

  .copyBtn{margin-left:10px;padding:6px 10px;background:#3b82f6;color:#fff;border:0;border-radius:8px;cursor:pointer}
  .copyBtn:hover{background:#2563eb}

  .locked{display:none!important}

  .fade-in{animation:fade .45s ease}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

  .tooltip{position:relative;display:inline-block}
  .tooltip .tiptext{visibility:hidden;background:rgba(0,0,0,.75);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px;position:absolute;z-index:10;top:-36px;left:50%;transform:translateX(-50%);white-space:nowrap}
  .tooltip:hover .tiptext{visibility:visible}

  .small{font-size:13px;color:#666}
  .note{max-width:900px;margin:8px auto 0;color:#444;text-align:center}
</style>
</head>
<body>

  <h1>üìÅ Pass CADENA ƒë√£ c·∫•p</h1>

  <button id="unlockBtn">üîë Xem Pass CADENA ƒë√£ c·∫•p</button>
  <div id="lockNotice">üîí D·ªØ li·ªáu nh·∫°y c·∫£m ƒëang ·∫©n ‚Äî nh·∫≠p KEY ƒë·ªÉ m·ªü kh√≥a</div>

  <input id="searchBox" placeholder="T√¨m theo MSNV ho·∫∑c H·ªç T√™n‚Ä¶" />

  <div class="note small">
    Ki·ªÉm tra v√† nh·∫≠p ƒë√∫ng th√¥ng tin. B·∫•m Copy ƒë·ªÉ tr√°nh sai s√≥t.  
    Sau khi ƒëƒÉng nh·∫≠p l·∫°i vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u m·ªõi ƒë·ªÉ tr√°nh l·ªô th√¥ng tin c·ªßa b·∫°n nh√©!
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>MSNV</th><th>H·ªç T√™n</th><th>BU</th><th>B·ªô ph·∫≠n</th>
        <th class="colSensitive">L√Ω do c·∫•p l·∫°i</th>
        <th class="colSensitive">M·∫≠t Kh·∫©u M·ªõi</th>
        <th class="colSensitive">Team</th>
        <th class="colSensitive">Ng√†y C·∫•p L·∫°i</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

<script>
/* RAW FILE URL */
const RAW_URL = "https://raw.githubusercontent.com/hoailuan0311-code/ChamCongDashboard/main/datapassCadena.js";

let passData = [];
let unlocked = false;
let currentKey = "";

/* LOAD RAW DATA (d√πng JSON ho·∫∑c JS ƒë·ªÅu ƒë∆∞·ª£c) */
async function loadRawData(){
  try{
    const r = await fetch(RAW_URL + "?v=" + Date.now(), {cache:"no-store"});
    const txt = await r.text();

    try {
      const j = JSON.parse(txt);
      if(Array.isArray(j)){ passData = j; return; }
    } catch(e){}

    const match = txt.match(/\[([\s\S]*)\]/m);
    if(match){
      passData = JSON.parse("[" + match[1] + "]");
      return;
    }

    alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu trong datapassCadena.js");
  } catch(err){
    alert("L·ªói load d·ªØ li·ªáu: " + err.message);
  }
}

/* EXCEL DATE ‚Üí STRING */
function excelDateToString(v){
  if(v === undefined || v === null || v === "") return "";
  if(!isNaN(Number(v))){
    const n = Number(v);
    if(n > 25000){
      const d = new Date((n - 25569) * 86400 * 1000);
      return d.toLocaleDateString("en-GB");
    }
  }
  const d2 = new Date(v);
  if(!isNaN(d2)) return d2.toLocaleDateString("en-GB");
  return v + "";
}

/* RENDER TABLE */
function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  const q = (searchBox.value || "").toLowerCase();

  let data = unlocked && currentKey
    ? passData.filter(r => (""+(r.Key||"")).toLowerCase() === currentKey)
    : [];

  if(q){
    data = data.filter(r =>
      (r.MSNV+"").toLowerCase().includes(q) ||
      (r.HoTen+"").toLowerCase().includes(q)
    );
  }

  for(const r of data){
    const hasPass = r.MatKhauMoi && (r.MatKhauMoi+"").trim() !== "";
    const hasDate = r.NgayCapLai && (r.NgayCapLai+"").trim() !== "";

    const mkHtml = hasPass
      ? `<div class="tooltip"><span class="done">${escapeHtml(r.MatKhauMoi)}</span><span class="tiptext">ƒê√£ c·∫•p m·∫≠t kh·∫©u</span></div>
         <button class="copyBtn" onclick="copyText('${escapeAttr(r.MatKhauMoi)}')">Copy</button>`
      : `<div class="tooltip"><span class="pending">‚è≥ Pending</span><span class="tiptext">Ch·ªù HR c·∫≠p nh·∫≠t</span></div>`;

    const ngayHtml = hasDate
      ? `<div class="tooltip"><span class="done">${excelDateToString(r.NgayCapLai)}</span><span class="tiptext">ƒê√£ c·∫•p</span></div>`
      : `<div class="tooltip"><span class="pending">‚è≥ Pending</span><span class="tiptext">ƒêang ch·ªù x·ª≠ l√Ω</span></div>`;

    tbody.insertAdjacentHTML("beforeend", `
      <tr class="fade-in">
        <td>${excelDateToString(r.Date)}</td>
        <td>${escapeHtml(r.MSNV)}</td>
        <td>${escapeHtml(r.HoTen)}</td>
        <td>${escapeHtml(r.BU)}</td>
        <td>${escapeHtml(r.BoPhan)}</td>
        <td class="colSensitive">${escapeHtml(r.LyDo)}</td>
        <td class="colSensitive">${mkHtml}</td>
        <td class="colSensitive">${escapeHtml(r.Team)}</td>
        <td class="colSensitive">${ngayHtml}</td>
      </tr>
    `);
  }
}

/* ESCAPE HTML */
function escapeHtml(s){
  if(s === undefined || s === null) return "";
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

/* COPY */
function copyText(t){
  navigator.clipboard.writeText(t+"")
    .then(()=> alert("üìã ƒê√£ copy m·∫≠t kh·∫©u!"));
}

/* SHOW/HIDE SENSITIVE COLUMNS */
function setSensitiveVisibility(show){
  document.querySelectorAll(".colSensitive").forEach(el =>
    show ? el.classList.remove("locked") : el.classList.add("locked")
  );
}

/* INIT */
(async function init(){
  setSensitiveVisibility(false);

  searchBox.addEventListener("input", renderTable);

  unlockBtn.addEventListener("click", async ()=>{
    if(passData.length === 0) await loadRawData();

    const key = (prompt("Nh·∫≠p KEY ƒë·ªÉ m·ªü d·ªØ li·ªáu:") || "").trim().toLowerCase();
    if(!key) return;

    const ok = passData.some(r => (""+(r.Key||"")).toLowerCase() === key);
    if(!ok){ alert("‚ùå KEY kh√¥ng t·ªìn t·∫°i ho·∫∑c sai."); return; }

    unlocked = true;
    currentKey = key;
    lockNotice.style.display = "none";
    setSensitiveVisibility(true);
    renderTable();
  });

  await loadRawData();
})();
</script>


<script>
// ===================== THEME LOADER (FINAL + UI COLOR FIX) =====================
async function loadTheme() {
    try {
        const cfg = await fetch("theme/themeList.json?v=" + Date.now());
        const { activeTheme } = await cfg.json();

        if (activeTheme === "default") return;

        const themeFile = await fetch(`theme/${activeTheme}.json?v=` + Date.now());
        const theme = await themeFile.json();

        // ph·∫£i c√≥ override: true
        if (!theme.override) return;

        // BACKGROUND + TEXT
        if (theme.background) document.body.style.background = theme.background;
        if (theme.textColor) document.body.style.color = theme.textColor;
        if (theme.font) document.body.style.fontFamily = theme.font;

        // UI COLORS FIX
        if (theme.uiColors) {
            const s = document.createElement("style");
            s.id = "theme-ui";
            s.innerHTML = `
                table { background:${theme.uiColors.tableBg || "inherit"} !important; }
                table td, table th { color:${theme.uiColors.tableText || "inherit"} !important; }
                th { background:${theme.uiColors.tableHeaderBg || "inherit"} !important; }
                .chart-box { background:${theme.uiColors.cardBg || "inherit"} !important;
                             border-color:${theme.uiColors.boxBorder || "inherit"} !important; }
            `;
            document.head.appendChild(s);
        }

        // MUSIC
        if (theme.music) {
            const audio = document.createElement("audio");
            audio.src = "theme/" + theme.music;
            audio.loop = true;
            audio.autoplay = true;
            audio.volume = 0.45;
            audio.id = "themeMusic";
            document.body.appendChild(audio);
        }

        // EFFECT
        if (theme.effect) {
            const script = document.createElement("script");
            script.src = "theme/" + theme.effect;
            document.body.appendChild(script);
        }

        // FIX Z-INDEX CHO TUY·∫æT / PH√ÅO HOA
        const fixLayer = document.createElement("style");
        fixLayer.innerHTML = `
            body, table, th, td {
                position: relative;
                z-index: 1;
            }
        `;
        document.head.appendChild(fixLayer);

    } catch (err) {
        console.error("Theme load error:", err);
    }
}

loadTheme();
</script>

</body>
</html>
