<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>üîê Pass CADENA ƒë√£ c·∫•p</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:"Be Vietnam Pro",sans-serif;background:#f1f5f9;padding:24px}
  h1{text-align:center;color:#00aaff;font-size:40px;margin:6px 0 10px;font-weight:800}
  #unlockBtn{display:block;margin:12px auto;padding:12px 32px;background:linear-gradient(135deg,#a78bfa,#818cf8);color:#fff;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  #lockNotice{text-align:center;color:#666;margin-bottom:12px}
  #searchBox{display:block;margin:10px auto 18px;padding:10px 14px;width:360px;border-radius:10px;border:1px solid #ddd}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:12px;border-bottom:1px solid #eee;text-align:left}
  th{background:#f8fafc;font-weight:700}
  .pending{background:#fcd34d;color:#422; padding:6px 12px;border-radius:10px;animation:blink 1.2s infinite}
  .done{background:#4ade80;color:#062;padding:6px 12px;border-radius:10px}
  @keyframes blink{50%{opacity:.4}}
  .copyBtn{margin-left:10px;padding:6px 10px;background:#3b82f6;color:#fff;border:0;border-radius:8px;cursor:pointer}
  .copyBtn:hover{background:#2563eb}
  .locked{display:none!important}
  .fade-in{animation:fade .45s ease}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tiptext{visibility:hidden;background:rgba(0,0,0,.75);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px;position:absolute;z-index:10;top:-36px;left:50%;transform:translateX(-50%);white-space:nowrap}
  .tooltip:hover .tiptext{visibility:visible}
  .small{font-size:13px;color:#666}
  .note{max-width:900px;margin:8px auto 0;color:#444;text-align:center}
</style>
</head>
<body>
  <h1>üìÅ Pass CADENA ƒë√£ c·∫•p</h1>

  <button id="unlockBtn">üîë Xem Pass CADENA ƒë√£ c·∫•p</button>
  <div id="lockNotice">üîí D·ªØ li·ªáu nh·∫°y c·∫£m ƒëang ·∫©n ‚Äî nh·∫≠p KEY ƒë·ªÉ m·ªü kh√≥a</div>

  <input id="searchBox" placeholder="T√¨m theo MSNV ho·∫∑c H·ªç T√™n‚Ä¶" />

  <div class="note small">Vui l√≤ng ki·ªÉm tra v√† nh·∫≠p ƒë√∫ng th√¥ng tin. B·∫•m Copy ƒë·ªÉ tr√°nh sai s√≥t.</div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>MSNV</th><th>H·ªç T√™n</th><th>BU</th><th>B·ªô ph·∫≠n</th>
        <th class="colSensitive">L√Ω do c·∫•p l·∫°i</th>
        <th class="colSensitive">M·∫≠t Kh·∫©u M·ªõi</th>
        <th class="colSensitive">Team</th>
        <th class="colSensitive">Ng√†y C·∫•p L·∫°i</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

<script>
/*
  Robust loader: fetch raw file from GitHub (or any raw URL).
  - If file content is a JSON array -> parse directly
  - If file contains JS like `const name = [ ... ]` -> extract first [...] and parse
  - If you want different URL, change RAW_URL
*/
const RAW_URL = "https://raw.githubusercontent.com/hoailuan0311-code/ChamCongDashboard/main/datapassCadena.js";
// If you prefer .json: https://raw.githubusercontent.com/.../datapassCadena.json

let passData = [];        // final array of records
let unlocked = false;
let currentKey = "";

// helper: fetch + parse flexible JSON/JS
async function loadRawData(){
  try{
    const r = await fetch(RAW_URL + "?v=" + Date.now(), {cache: "no-store"});
    if(!r.ok) throw new Error("Fetch failed: " + r.status);
    const txt = await r.text();
    console.log("Raw file length:", txt.length);
    // Try to parse direct JSON first
    try {
      const j = JSON.parse(txt);
      if(Array.isArray(j)){ passData = j; console.log("Parsed as JSON array"); return; }
    } catch(e) { /* ignore */ }

    // Otherwise try to extract first JSON array inside text
    const match = txt.match(/\[([\s\S]*)\]/m);
    if(match){
      const jsonText = "[" + match[1] + "]";
      passData = JSON.parse(jsonText);
      console.log("Extracted JSON array from JS wrapper");
      return;
    }

    // If still nothing
    throw new Error("Kh√¥ng t√¨m th·∫•y m·∫£ng JSON trong file raw.");
  } catch(err){
    console.error("loadRawData error:", err);
    alert("L·ªói load d·ªØ li·ªáu: " + err.message + "\nKi·ªÉm tra RAW_URL ho·∫∑c file tr√™n GitHub.");
  }
}

// date conversion: accept number or numeric-string excel serial, or ISO-like string
function excelDateToString(v){
  if(v === undefined || v === null || v === "") return "";
  // if looks numeric (like "46001" or 46001)
  if(!isNaN(Number(v))){
    const n = Number(v);
    // guard unrealistic small numbers
    if(n > 25000){
      const d = new Date((n - 25569) * 86400 * 1000);
      if(!isNaN(d)) return d.toLocaleDateString("en-GB");
    }
  }
  // otherwise try Date parse
  const d2 = new Date(v);
  if(!isNaN(d2)) return d2.toLocaleDateString("en-GB");
  return v + "";
}

// render table based on current filters and unlocked state
function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const q = (document.getElementById("searchBox").value || "").toLowerCase();

  // filter: if unlocked -> only rows with same KEY; if locked -> none show (or could show minimal rows)
  let data = passData.slice();

  // If unlocked, keep only rows with matching key. Otherwise show nothing sensitive (we'll still show nothing rows).
  if(unlocked && currentKey){
    data = data.filter(r => ("" + (r.Key||"")).toLowerCase() === currentKey);
  } else {
    // locked state: render zero rows (keeps headers)
    data = [];
  }

  // then filter by search
  if(q){
    data = data.filter(r => ((r.MSNV||"")+"").toLowerCase().includes(q) || ((r.HoTen||"")+"").toLowerCase().includes(q));
  }

  for(const r of data){
    const hasPass = r.MatKhauMoi && (r.MatKhauMoi+"").trim() !== "";
    const hasDate = r.NgayCapLai && (r.NgayCapLai+"").trim() !== "";

    const mkHtml = hasPass
      ? `<div class="tooltip"><span class="done">${escapeHtml(r.MatKhauMoi)}</span><span class="tiptext">ƒê√£ c·∫•p m·∫≠t kh·∫©u</span></div>
         <button class="copyBtn" onclick="copyText('${escapeAttr(r.MatKhauMoi)}')">Copy</button>`
      : `<div class="tooltip"><span class="pending">‚è≥ Pending</span><span class="tiptext">Ch·ªù HR c·∫≠p nh·∫≠t</span></div>`;

    const ngayHtml = hasDate
      ? `<div class="tooltip"><span class="done">‚úî ${excelDateToString(r.NgayCapLai)}</span><span class="tiptext">ƒê√£ c·∫•p</span></div>`
      : `<div class="tooltip"><span class="pending">‚è≥ Pending</span><span class="tiptext">ƒêang ch·ªù x·ª≠ l√Ω</span></div>`;

    tbody.insertAdjacentHTML("beforeend",
      `<tr class="fade-in">
         <td>${excelDateToString(r.Date)}</td>
         <td>${escapeHtml(r.MSNV)}</td>
         <td>${escapeHtml(r.HoTen)}</td>
         <td>${escapeHtml(r.BU)}</td>
         <td>${escapeHtml(r.BoPhan)}</td>
         <td class="colSensitive">${escapeHtml(r.LyDo)}</td>
         <td class="colSensitive">${mkHtml}</td>
         <td class="colSensitive">${escapeHtml(r.Team)}</td>
         <td class="colSensitive">${ngayHtml}</td>
       </tr>`
    );
  }
}

// utility: escape for HTML and attributes
function escapeHtml(s){
  if(s === undefined || s === null) return "";
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

// copy
function copyText(t){
  navigator.clipboard.writeText(t+"").then(()=>alert("üìã ƒê√£ copy m·∫≠t kh·∫©u!"), ()=>alert("Kh√¥ng th·ªÉ copy."));
}

// toggle sensitive columns hidden class
function setSensitiveVisibility(visible){
  document.querySelectorAll(".colSensitive").forEach(el=>{
    if(visible) el.classList.remove("locked"); else el.classList.add("locked");
  });
}

// initialize: hide sensitive columns first, attach listeners, load data
(async function init(){
  setSensitiveVisibility(false); // hide initially
  document.getElementById("searchBox").addEventListener("input", renderTable);
  document.getElementById("unlockBtn").addEventListener("click", async ()=>{
    // if passData empty try to reload
    if(passData.length === 0) await loadRawData();

    const key = (prompt("Nh·∫≠p KEY ƒë·ªÉ m·ªü d·ªØ li·ªáu:") || "").trim().toLowerCase();
    if(!key) return;

    // check
    const ok = passData.some(r => (""+(r.Key||"")).toLowerCase() === key);
    if(!ok){ alert("‚ùå KEY kh√¥ng t·ªìn t·∫°i ho·∫∑c sai."); return; }

    // unlock
    unlocked = true;
    currentKey = key;
    document.getElementById("lockNotice").style.display = "none";
    setSensitiveVisibility(true);
    renderTable();
  });

  // initial load: fetch data but still locked, so nothing visible
  await loadRawData();
  console.log("Loaded records:", passData.length);
  // If you want to auto-unlock for testing, set unlocked=true and currentKey to first key:
  // unlocked = true; currentKey = (passData[0] && (passData[0].Key||"").toLowerCase());
  // setSensitiveVisibility(true); renderTable();
})();
</script>
</body>
</html>
