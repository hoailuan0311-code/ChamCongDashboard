name: Process Delivery Note

on:
  repository_dispatch:
    types: [process_dn]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install QR & Image tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zbar-tools imagemagick

      - name: Process temp image
        env:
          TMP_PATH: ${{ github.event.client_payload.tmp_path }}
          ORIGINAL_NAME: ${{ github.event.client_payload.original }}
          USER_NAME: ${{ github.event.client_payload.user }}
        run: |
          echo "TMP_PATH=$TMP_PATH"
          echo "ORIGINAL_NAME=$ORIGINAL_NAME"
          echo "USER_NAME=$USER_NAME"

          mkdir -p inbox/Done inbox/Failed logs

          # Đọc QR từ file tạm
          QR=$(zbarimg --raw "$TMP_PATH" 2>/dev/null || echo "")
          echo "QR: '$QR'"

          # Nén ảnh
          COMPRESSED="compressed.jpg"
          convert "$TMP_PATH" -resize 1400x -quality 40 "$COMPRESSED"

          # Quyết định đường dẫn đích
          if [ -z "$QR" ]; then
            DEST="inbox/Failed/$ORIGINAL_NAME"
            STATUS="FAILED_QR"
          else
            SAFE=$(echo "$QR" | tr -cd '[:alnum:]_-')
            DEST="inbox/Done/${SAFE}.jpg"
            STATUS="DONE"
          fi

          echo "DEST=$DEST"
          cp "$COMPRESSED" "$DEST"

          # Xóa file tạm (tránh đầy repo)
          rm -f "$TMP_PATH"

          # Cập nhật log JSON
          LOG_PATH="logs/upload_log.json"
          if [ ! -f "$LOG_PATH" ]; then
            echo "[]" > "$LOG_PATH"
          fi

          TIME_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          node << 'EOF'
          const fs = require("fs");
          const path = "logs/upload_log.json";

          let arr = [];
          try {
            arr = JSON.parse(fs.readFileSync(path, "utf8"));
          } catch (e) {
            arr = [];
          }

          const entry = {
            user: process.env.USER_NAME,
            fileOriginal: process.env.ORIGINAL_NAME,
            tmpPath: process.env.TMP_PATH,
            savedAs: process.env.DEST,
            qr: process.env.QR_VALUE || "",
            status: process.env.STATUS,
            time: process.env.TIME_UTC
          };

          arr.push(entry);
          fs.writeFileSync(path, JSON.stringify(arr, null, 2));
          EOF
        env:
          DEST: ${{ env.DEST }}
          QR_VALUE: ${{ env.QR }}
          STATUS: ${{ env.STATUS }}
          TIME_UTC: ${{ env.TIME_UTC }}

      - name: Commit updates
        run: |
          git config user.name "Upload-Bot"
          git config user.email "bot@example.com"
          git add inbox logs
          git commit -m "Process uploaded Delivery Note" || echo "No changes"
          git push
