name: Process Delivery Note

on:
  repository_dispatch:
    types: [process_dn]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zbar-tools imagemagick

      - name: Run processor
        env:
          TMP_PATH: ${{ github.event.client_payload.tmp_path }}
          ORIGINAL: ${{ github.event.client_payload.original }}
          USER_NAME: ${{ github.event.client_payload.user }}
        run: |
          echo "TMP_PATH=$TMP_PATH"
          echo "ORIGINAL=$ORIGINAL"
          echo "USER=$USER_NAME"

          mkdir -p inbox/Done inbox/Failed logs

          QR=$(zbarimg --raw "$TMP_PATH" 2>/dev/null || echo "")

          convert "$TMP_PATH" -resize 1400x -quality 40 compressed.jpg

          if [ -z "$QR" ]; then
            DEST="inbox/Failed/$ORIGINAL"
            STATUS="FAILED_QR"
          else
            CLEAN=$(echo "$QR" | tr -cd '[:alnum:]_-')
            DEST="inbox/Done/${CLEAN}.jpg"
            STATUS="DONE"
          fi

          echo "Saving to: $DEST"
          cp compressed.jpg "$DEST"

          rm -f "$TMP_PATH"

          LOG=logs/upload_log.json
          if [ ! -f "$LOG" ]; then echo "[]" > "$LOG"; fi

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          printf '%s\n' "
          const fs=require('fs');
          const logPath='logs/upload_log.json';
          let log=JSON.parse(fs.readFileSync(logPath));
          log.push({
            user: process.env.USER_NAME,
            original: process.env.ORIGINAL,
            tmp: process.env.TMP_PATH,
            saved_as: '$DEST',
            status: '$STATUS',
            qr: '$QR',
            time: '$TS'
          });
          fs.writeFileSync(logPath, JSON.stringify(log,null,2));
          " > log.js

          node log.js
          rm log.js

      - name: Commit results
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "Upload Bot"
          git add inbox logs
          git commit -m "Processed DN image" || true
          git push
