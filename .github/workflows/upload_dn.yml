name: Process Delivery Note

on:
  repository_dispatch:
    types: [process_dn]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install QR & Image tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zbar-tools imagemagick

      - name: Process temp image
        env:
          TMP_PATH: ${{ github.event.client_payload.tmp_path }}
          ORIGINAL_NAME: ${{ github.event.client_payload.original }}
          USER_NAME: ${{ github.event.client_payload.user }}
        run: |
          echo "TMP_PATH = $TMP_PATH"
          echo "ORIGINAL_NAME = $ORIGINAL_NAME"
          echo "USER_NAME = $USER_NAME"

          mkdir -p inbox/Done inbox/Failed logs

          # đọc QR từ file
          QR=$(zbarimg --raw "$TMP_PATH" 2>/dev/null || echo "")
          echo "QR = '$QR'"

          # nén ảnh
          convert "$TMP_PATH" -resize 1400x -quality 40 "compressed.jpg"

          # xác định nơi lưu
          if [ -z "$QR" ]; then
            DEST="inbox/Failed/$ORIGINAL_NAME"
            STATUS="FAILED_QR"
          else
            SAFE=$(echo "$QR" | tr -cd '[:alnum:]_-')
            DEST="inbox/Done/${SAFE}.jpg"
            STATUS="DONE"
          fi

          cp "compressed.jpg" "$DEST"

          # xóa file tạm
          rm -f "$TMP_PATH"

          # cập nhật log
          LOG="logs/upload_log.json"
          if [ ! -f "$LOG" ]; then echo "[]" > "$LOG"; fi

          TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          node <<EOF
const fs = require("fs");
const logPath = "logs/upload_log.json";
let log = [];

try { log = JSON.parse(fs.readFileSync(logPath)); } catch {}

log.push({
  user: process.env.USER_NAME,
  fileOriginal: process.env.ORIGINAL_NAME,
  tmpPath: process.env.TMP_PATH,
  savedAs: process.env.DEST,
  qr: "${QR}",
  status: process.env.STATUS,
  time: "${TIME}"
});

fs.writeFileSync(logPath, JSON.stringify(log, null, 2));
EOF

      - name: Commit updates
        run: |
          git config user.name "Upload-Bot"
          git config user.email "bot@example.com"
          git add inbox logs
          git commit -m "Processed DN" || echo "No changes"
          git push
